# Implementation Review (2026-01-24)

## Scope

This review covers the recent implementations for:

- Project “file system” / persistence
- Project templates
- Visual ↔ Code mode (one-way Visual → Code generation)
- Debug mode (highlight execution / breakpoints)

Code areas reviewed:

- `visual-editor/src/App.tsx`
- `visual-editor/src/types.ts`
- `visual-editor/src/data/projectTemplates.ts`
- `visual-editor/src/components/NewProjectDialog.tsx`
- `visual-editor/src/components/CodeView.tsx`
- `visual-editor/src/components/DebugOverlay.tsx`
- `daq_core/engine.py`
- `daq_core/components/*`

## High-level Result

- The **UI flow** (New Project dialog, template loading, Code view, Debug toggle) works in the browser.
- However, there are **multiple backend integration and codegen correctness issues** that will prevent the “generated Python code” from running and will block end-to-end MVP verification once new components (ThresholdAlarm/Modbus/DebugPrint/GlobalVariable) are actually used.

---

# Findings (Issues First, No Fixes)

## Critical (will break runtime / block MVP path)

### 1) `daq_core.components` exports are incomplete → generated code will fail to import

- **Where**: `daq_core/components/__init__.py`
- **Problem**:
  - Only exports:
    - `MQTTSubscriberComponent`, `MQTTPublisherComponent`, `MockDeviceComponent`, `MathOperationComponent`, `CompareComponent`, `CSVStorageComponent`, `CustomScriptComponent`.
  - Does **not** export:
    - `ThresholdAlarmComponent`, `ModbusClientComponent`, `DebugPrintComponent`, `GlobalVariableComponent`.
- **Impact**:
  - Code generated by `CodeView.tsx` uses:
    - `from daq_core.components import ( ... ThresholdAlarmComponent, ModbusClientComponent, DebugPrintComponent, GlobalVariableComponent, ...)`
  - This will raise **ImportError**.

### 2) `CodeView` generated Python code does not match actual `DAQEngine` and component APIs

- **Where**: `visual-editor/src/components/CodeView.tsx`
- **Problems**:
  - **Engine API mismatch**:
    - Backend: `DAQEngine.add_component(component_name: str, instance_id, config)`
    - Codegen: creates component objects and calls `engine.add_component(componentObj)`.
  - **Engine.connect mismatch**:
    - Backend: `connect(source_id: str, source_port: str, target_id: str, target_port: str)`
    - Codegen: `engine.connect(componentObj, "port", componentObj, "port")`.
  - **Component constructor mismatch**:
    - Backend `ComponentBase.__init__(instance_id=None)` does not accept `config=`.
    - Codegen uses `MockDeviceComponent(instance_id="...", config={...})`.
  - **Python syntax mismatch from JSON**:
    - Codegen uses `JSON.stringify()` which emits `true/false/null` (JS), not `True/False/None` (Python).
- **Impact**:
  - The generated Python code is **not runnable** as-is.

### 3) Multiple backend component files appear internally inconsistent with current `ComponentRegistry` API

- **Where**:
  - `daq_core/components/threshold_alarm.py`
  - `daq_core/components/modbus_client.py`
  - `daq_core/components/debug_print.py`
  - `daq_core/components/global_variable.py`
- **Problems (examples)**:
  - These files use `@ComponentRegistry.register('Name')`.
  - But `ComponentRegistry.register` in `daq_core/components/base.py` signature is:
    - `register(cls, component_class: type)` (expects a class, not a string).
- **Impact**:
  - If these modules are imported, they may raise errors or fail to register.
  - Currently they might not be imported at all (see next finding).

### 4) New components are not guaranteed to be registered (modules not imported)

- **Where**: `daq_core/components/__init__.py`
- **Problem**:
  - Not importing the new component modules means the decorators don’t run → registry doesn’t know them.
- **Impact**:
  - Even if frontend can place nodes, the backend may be unable to instantiate them at runtime / compile time.

### 5) `DAQEngine` only processes a hard-coded subset of components

- **Where**: `daq_core/engine.py`, method `_main_loop`
- **Problem**:
  - Engine only calls `process()` for components where `component.component_name` is in:
    - `["MathOperation", "Compare", "CSVStorage", "CustomScript"]`
  - That excludes:
    - `ThresholdAlarm`, `DebugPrint`, `GlobalVariable`, `ModbusClient` (and likely others).
- **Impact**:
  - Even if components are registered and instantiated, they may **never execute**.
  - This blocks the MVP “threshold alarm” scenario.

### 6) ComponentType enum mismatch in some components

- **Where**:
  - `daq_core/components/threshold_alarm.py` sets `component_type = ComponentType.PROCESS`
  - `daq_core/components/debug_print.py` sets `component_type = ComponentType.PROCESS`
- **Problem**:
  - `ComponentType` in `daq_core/components/base.py` does not define `PROCESS`.
- **Impact**:
  - Importing these modules would likely error.

---

## High (functional gaps / incorrect behavior vs MVP expectation)

### 7) “Project file system” is still localStorage-first, not `.daq`-first

- **Where**: `visual-editor/src/App.tsx`
- **Observed behavior**:
  - Nodes/edges are persisted to localStorage keys:
    - `daq-nodes`, `daq-edges`.
  - Project meta is separately stored to `daq-project` only when creating from template.
  - Export/Import uses browser file picker / download, but **editing state is not backed by a single authoritative `.daq` project object**.
- **Impact**:
  - This does not satisfy the doc’s “replace localStorage with file system”.
  - Risk of meta vs nodes/edges desynchronization.

### 8) Schema version inconsistency

- **Where**:
  - Templates: `schemaVersion: '2.0.0'`
  - Existing export code in `App.tsx`: still uses `schemaVersion: '0.1.0'` and meta `"New Project"`.
- **Impact**:
  - Confusing project format evolution.
  - Import/export compatibility may become fragile.

### 9) Dashboard is not driven by `project.ui.widgets`

- **Where**: `visual-editor/src/components/Dashboard.tsx`
- **Problem**:
  - Dashboard rendering is mostly fixed and uses MQTT topics like `sensors/temperature` and `accudaq/#`.
  - Template `ui.widgets` (line_chart/gauge/led with `dataSource`) is currently unused.
- **Impact**:
  - The “Dashboard designer” and template UI definitions are not part of the runtime.

---

## Medium (quality / maintainability / partial implementation)

### 10) Debug mode is UI-only; no real execution highlighting or breakpoint handling

- **Where**:
  - `visual-editor/src/App.tsx`
  - `visual-editor/src/components/DebugOverlay.tsx`
- **Problems**:
  - `DebugOverlay` is created but not integrated into node rendering (`DAQNode.tsx`) or ReactFlow nodes.
  - `toggleBreakpoint()` exists but is unused in UI → breakpoints cannot actually be set.
  - No data channel from engine to frontend to identify “executing node”, port values, pause/resume.
- **Impact**:
  - Does not meet MVP requirement: “高亮执行（慢速显示数据流向）”.

### 11) Types and runtime structures are not fully aligned

- **Where**: `visual-editor/src/types.ts`
- **Notes**:
  - `DebugState.breakpoints` uses `Set<string>` which is not JSON-serializable. If you later persist debug state, it will require special handling.

### 12) CSV Storage port name mismatch risk

- **Where**:
  - Frontend component definition: `visual-editor/src/data/componentLibrary.ts` lists output `rows_written`.
  - Backend component: `daq_core/components/csv_storage.py` outputs `row_count` and `success`.
- **Impact**:
  - Port mapping and UI expectations may diverge.

---

# Summary of Most Important Risks

- **Generated Python code is not runnable** due to engine/component API mismatch and invalid Python literals.
- **New backend components are not properly integrated** (export/import/registration/type issues) → cannot reliably reach MVP acceptance workflow.
- **Debug mode currently does not implement execution highlighting** (only a toggle + status line).

---

# Suggested Next Steps (No changes made in this task)

1. Make backend component registration consistent (registry decorator API + ensure modules are imported).
2. Decide the authoritative project format and storage:
   - localStorage (dev only) vs `.daq` file system (real).
3. Align CodeView codegen with:
   - `DAQEngine.add_component()` signature
   - `DAQEngine.connect()` signature
   - component construction + config application
   - Python literal formatting.
4. Implement debug execution data flow:
   - engine emits current executing node + port values via MQTT/websocket
   - frontend highlights nodes/edges and supports breakpoints.

---

## Glossary (English → 中文)

- **Critical**: 严重问题（会直接导致运行失败/阻塞主流程）
- **Schema version**: 文件格式版本
- **Registration**: 注册（组件注册到Registry）
- **One-way conversion**: 单向转换（可视化 → 代码）
- **Authoritative source of truth**: 唯一权威数据源（避免多份数据不同步）
