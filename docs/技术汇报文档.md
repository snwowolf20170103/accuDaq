# accuDaq å¯è§†åŒ–æ•°æ®é‡‡é›†ç³»ç»ŸæŠ€æœ¯æ±‡æŠ¥

## ä¸€ã€é¡¹ç›®æ¦‚è¿°

**accuDaq** æ˜¯ä¸€ä¸ªåŸºäºç¼–è¯‘å™¨æ¶æ„çš„å¯è§†åŒ–æ•°æ®é‡‡é›†ç³»ç»Ÿã€‚ç”¨æˆ·é€šè¿‡æ‹–æ‹½ç»„ä»¶åœ¨å¯è§†åŒ–ç¼–è¾‘å™¨ä¸­æ„å»ºæ•°æ®æµ,ç³»ç»Ÿå°† `.daq` JSON æ–‡ä»¶ç¼–è¯‘ä¸ºå¯æ‰§è¡Œçš„ Python ä»£ç å¹¶è¿è¡Œã€‚

### æ ¸å¿ƒæŠ€æœ¯æ ˆ
- **å‰ç«¯**: React 18 + TypeScript + Vite + @xyflow/react
- **åç«¯**: Python 3.x + paho-mqtt
- **é€šä¿¡**: MQTT åè®® (å®æ—¶æ•°æ®ä¼ è¾“)
- **æ¶æ„æ¨¡å¼**: ç¼–è¯‘å™¨ + ç»„ä»¶æ³¨å†Œè¡¨ + äº‹ä»¶é©±åŠ¨å¼•æ“

---

## äºŒã€å‰åç«¯å…³è”æœºåˆ¶è¯¦è§£ â­

è¿™æ˜¯æ•´ä¸ªç³»ç»Ÿæœ€æ ¸å¿ƒçš„è®¾è®¡,å‰ç«¯æ§ä»¶å’Œåå°ç»„ä»¶é€šè¿‡ä»¥ä¸‹**å››å±‚æ˜ å°„æœºåˆ¶**å®ç°æ— ç¼å…³è”:

### 2.1 ç¬¬ä¸€å±‚:ç»„ä»¶å®šä¹‰æ˜ å°„

#### å‰ç«¯ç»„ä»¶å®šä¹‰ (`componentLibrary.ts`)
```typescript
{
    type: 'mock_device',              // ç»„ä»¶ç±»å‹æ ‡è¯†
    name: 'Mock Device',              // æ˜¾ç¤ºåç§°
    category: 'device',               // åˆ†ç±»
    icon: 'ğŸ²',                       // å›¾æ ‡
    inputs: [],                       // è¾“å…¥ç«¯å£å®šä¹‰
    outputs: [
        { id: 'value', name: 'Value', type: 'number' },
        { id: 'data', name: 'Data', type: 'object' }
    ],
    defaultProperties: {              // é»˜è®¤é…ç½®
        wave_type: 'sine',
        amplitude: 10,
        broker_host: 'localhost',
        topic: 'accudaq/demo/sensor'
    },
    propertySchema: [...]             // å±æ€§ç¼–è¾‘å™¨é…ç½®
}
```

#### åç«¯ç»„ä»¶å®ç° (`components/mock_device.py`)
```python
@ComponentRegistry.register
class MockDeviceComponent(ComponentBase):
    component_name = "MockDevice"     # å¯¹åº”å‰ç«¯çš„æ˜ å°„é”®
    component_type = ComponentType.DEVICE

    def _setup_ports(self):
        # å®šä¹‰ä¸å‰ç«¯ä¸€è‡´çš„ç«¯å£
        self.add_output_port("value", PortType.NUMBER)
        self.add_output_port("data", PortType.OBJECT)

    def configure(self, config):
        # æ¥æ”¶å‰ç«¯ä¼ å…¥çš„å±æ€§
        self.wave_type = config.get('wave_type', 'sine')
        self.amplitude = config.get('amplitude', 10)
        self.topic = config.get('topic')
```

**å…³é”®å…³è”ç‚¹**:
- å‰ç«¯ `type: 'mock_device'` â†’ ç¼–è¯‘å™¨æ˜ å°„ â†’ åç«¯ `component_name = "MockDevice"`
- å‰ç«¯ `outputs` å®šä¹‰ â†’ åç«¯ `_setup_ports()` ç«¯å£åˆ›å»º
- å‰ç«¯ `defaultProperties` â†’ åç«¯ `configure(config)` å‚æ•°æ¥æ”¶

---

### 2.2 ç¬¬äºŒå±‚:ç¼–è¯‘å™¨ç±»å‹æ˜ å°„ (`codegen.py`)

```python
NODE_TYPE_MAPPING = {
    # å‰ç«¯ç±»å‹æ ‡è¯† â†’ åç«¯ç»„ä»¶ç±»å
    "daq:mock_device": "MockDevice",
    "daq:mqtt_subscribe": "MQTTSubscriber",
    "daq:mqtt_publish": "MQTTPublisher",
    "daq:math": "MathOperation",
    "daq:csv_storage": "CSVStorage",
}
```

è¿™ä¸ªæ˜ å°„è¡¨æ˜¯**å‰åç«¯åä½œçš„æ¡¥æ¢**:
1. å‰ç«¯æ‹–æ‹½ `Mock Device` ç»„ä»¶åˆ°ç”»å¸ƒ
2. å¯¼å‡ºæ—¶ç”Ÿæˆ `"type": "daq:mock_device"` çš„ JSON èŠ‚ç‚¹
3. ç¼–è¯‘å™¨è¯»å–åæŸ¥æ‰¾æ˜ å°„: `"daq:mock_device"` â†’ `"MockDevice"`
4. ç”Ÿæˆä»£ç : `engine.add_component("MockDevice", config)`
5. è¿è¡Œæ—¶é€šè¿‡ `ComponentRegistry.create("MockDevice")` åˆ›å»ºå®ä¾‹

---

### 2.3 ç¬¬ä¸‰å±‚:æ•°æ®æµæ–‡ä»¶ (.daq JSON)

ç”¨æˆ·åœ¨å‰ç«¯ç¼–è¾‘å™¨çš„æ“ä½œä¼šç”Ÿæˆä¸­é—´è¡¨ç¤ºæ–‡ä»¶:

```json
{
  "logic": {
    "nodes": [
      {
        "id": "f328329b-505a-4dd5-9c3a-b0a5be263a35",
        "type": "daq:mock_device",           // å‰ç«¯ç±»å‹
        "label": "Mock Device",
        "position": { "x": 234, "y": 147 },  // ä»…ç”¨äºå‰ç«¯æ˜¾ç¤º
        "properties": {                       // ç”¨æˆ·é…ç½®çš„å±æ€§
          "wave_type": "sine",
          "amplitude": 20,
          "topic": "accudaq/demo/sensor"
        }
      }
    ],
    "wires": [                               // è¿çº¿å…³ç³»
      {
        "source": { "nodeId": "f328...", "portId": "value" },
        "target": { "nodeId": "3f88...", "portId": "input1" }
      }
    ]
  }
}
```

**æ–‡ä»¶ä½œç”¨**:
- å‰ç«¯å¯è¯»å¯å†™ (ä¿å­˜/åŠ è½½é¡¹ç›®)
- åç«¯ç¼–è¯‘å™¨çš„è¾“å…¥æº
- åŒæ—¶åŒ…å« UI ä¿¡æ¯å’Œæ‰§è¡Œé€»è¾‘

---

### 2.4 ç¬¬å››å±‚:ä»£ç ç”Ÿæˆä¸å®ä¾‹åŒ–

ç¼–è¯‘å™¨å°† `.daq` æ–‡ä»¶è½¬æ¢ä¸ºå¯æ‰§è¡Œ Python ä»£ç :

#### ç”Ÿæˆçš„ä»£ç ç‰‡æ®µ (`run_realtime_app.py`):
```python
# 1. å¯¼å…¥ç»„ä»¶ç±»
from daq_core.components import MockDeviceComponent, MathOperationComponent

def create_engine():
    engine = DAQEngine()

    # 2. åˆ›å»ºç»„ä»¶å®ä¾‹ (ä» JSON èŠ‚ç‚¹ç”Ÿæˆ)
    f328329b = engine.add_component("MockDevice", "f328329b-...", {
        "wave_type": "sine",
        "amplitude": 20,
        "topic": "accudaq/demo/sensor"
    })

    # 3. å»ºç«‹è¿æ¥ (ä» wires ç”Ÿæˆ)
    engine.connect(
        "f328329b-...", "value",  # æºèŠ‚ç‚¹ID, æºç«¯å£
        "3f88b6ca-...", "input1"  # ç›®æ ‡èŠ‚ç‚¹ID, ç›®æ ‡ç«¯å£
    )

    return engine
```

#### è¿è¡Œæ—¶æ‰§è¡Œæµç¨‹:
```python
# ComponentRegistry è‡ªåŠ¨æŸ¥æ‰¾å¹¶å®ä¾‹åŒ–
def add_component(self, component_name, instance_id, config):
    # é€šè¿‡æ³¨å†Œè¡¨åˆ›å»ºå®ä¾‹
    component = ComponentRegistry.create(component_name, instance_id, config)
    # MockDevice ç±»çš„ __init__ è¢«è°ƒç”¨
    # configure(config) è¢«è°ƒç”¨,è®¾ç½® wave_type, amplitude ç­‰
    self.components[instance_id] = component
```

---

## ä¸‰ã€å®Œæ•´æ•°æ®æµè½¬è¿‡ç¨‹

### 3.1 ç¼–è¾‘é˜¶æ®µ (å‰ç«¯ React)

```
ç”¨æˆ·æ‹–æ‹½ç»„ä»¶ â†’ ç”Ÿæˆ DAQNode å¯¹è±¡
    â†“
ç”¨æˆ·ä¿®æ”¹å±æ€§ â†’ æ›´æ–° node.properties
    â†“
ç”¨æˆ·è¿çº¿ â†’ åˆ›å»º DAQEdge å¯¹è±¡ (source/target ç«¯å£ä¿¡æ¯)
    â†“
ç‚¹å‡»å¯¼å‡º â†’ åºåˆ—åŒ–ä¸º .daq JSON æ–‡ä»¶
```

### 3.2 ç¼–è¯‘é˜¶æ®µ (Python ç¼–è¯‘å™¨)

```
Parser (parser.py):
    è¯»å– .daq JSON â†’ è§£æä¸º DAQProject å¯¹è±¡
    â†“
Topology Sort (topology.py):
    åˆ†æèŠ‚ç‚¹ä¾èµ–å…³ç³» â†’ ç”Ÿæˆæ‰§è¡Œé¡ºåº
    æ£€æµ‹å¾ªç¯ä¾èµ– â†’ ç¡®ä¿æ•°æ®æµåˆæ³•
    â†“
Code Generator (codegen.py):
    éå† nodes â†’ æŸ¥æ‰¾ NODE_TYPE_MAPPING
    ç”Ÿæˆ add_component() ä»£ç 
    éå† wires â†’ ç”Ÿæˆ connect() ä»£ç 
    â†“
è¾“å‡º: run_realtime_app.py (å¯æ‰§è¡Œè„šæœ¬)
```

### 3.3 è¿è¡Œé˜¶æ®µ (DAQEngine)

```
å¯åŠ¨å¼•æ“:
    1. è°ƒç”¨æ‰€æœ‰ç»„ä»¶çš„ start() æ–¹æ³•
    2. MQTT è¿æ¥å»ºç«‹, çº¿ç¨‹å¯åŠ¨
    â†“
ä¸»å¾ªç¯ (100ms å‘¨æœŸ):
    1. æ•°æ®ä¼ è¾“: æ ¹æ®è¿çº¿å°†æºç«¯å£æ•°æ®ä¼ åˆ°ç›®æ ‡ç«¯å£
       engine.transfer_data():
           source_port.value â†’ target_port.value

    2. å¤„ç†è§¦å‘: è°ƒç”¨æ‰€æœ‰ç»„ä»¶çš„ process()
       mock_device.process():
           ç”Ÿæˆæ•°æ® â†’ set_output("value", data)
           é€šè¿‡ MQTT å‘å¸ƒ

       math_op.process():
           è¯»å– get_input("input1")
           è®¡ç®—ç»“æœ â†’ set_output("result", result)

    3. ç­‰å¾…ä¸‹ä¸€å‘¨æœŸ
    â†“
åœæ­¢å¼•æ“:
    è°ƒç”¨æ‰€æœ‰ç»„ä»¶çš„ stop() å’Œ destroy()
```

---

## å››ã€ç«¯å£ç³»ç»Ÿè®¾è®¡

### 4.1 ç«¯å£å®šä¹‰çš„åŒå‘å¯¹åº”

| å±‚æ¬¡ | å‰ç«¯å®šä¹‰ | åç«¯å®ç° |
|------|---------|---------|
| **å®šä¹‰ä½ç½®** | `componentLibrary.ts` çš„ `inputs/outputs` | `_setup_ports()` æ–¹æ³• |
| **ç±»å‹ç³»ç»Ÿ** | `type: 'number'` | `PortType.NUMBER` |
| **ç«¯å£å®ä¾‹** | ä»…ç”¨äº UI å±•ç¤º | `Port` å¯¹è±¡ (å­˜å‚¨å®é™…å€¼) |
| **è¿æ¥éªŒè¯** | React Flow è¾¹è¿æ¥æ£€æŸ¥ | ç¼–è¯‘æ—¶æ‹“æ‰‘æ’åºæ£€æŸ¥ |

### 4.2 ç«¯å£æ•°æ®æµè½¬

```python
# åç«¯ Port ç±»
class Port:
    def __init__(self, name, port_type):
        self.value = None  # å­˜å‚¨å½“å‰å€¼

    def set_value(self, value):
        self.value = value  # å†™å…¥æ•°æ®

    def get_value(self):
        return self.value   # è¯»å–æ•°æ®

# ç»„ä»¶ä½¿ç”¨ç«¯å£
class MathOperation(ComponentBase):
    def process(self):
        # è¯»å–è¾“å…¥ç«¯å£
        input1 = self.get_input("input1")  # è°ƒç”¨ Port.get_value()

        # æ‰§è¡Œè®¡ç®—
        result = input1 * self.scale

        # å†™å…¥è¾“å‡ºç«¯å£
        self.set_output("result", result)  # è°ƒç”¨ Port.set_value()
```

---

## äº”ã€ç»„ä»¶æ³¨å†Œè¡¨æ¨¡å¼

### 5.1 è‡ªåŠ¨æ³¨å†Œæœºåˆ¶

```python
# è£…é¥°å™¨æ³¨å†Œ
@ComponentRegistry.register
class MockDeviceComponent(ComponentBase):
    component_name = "MockDevice"  # æ³¨å†Œé”®

# å†…éƒ¨å®ç°
class ComponentRegistry:
    _registry = {}  # å…¨å±€å­—å…¸

    @classmethod
    def register(cls, component_class):
        name = component_class.component_name
        cls._registry[name] = component_class  # å­˜å‚¨ç±»å¼•ç”¨
        return component_class
```

### 5.2 åŠ¨æ€åˆ›å»ºå®ä¾‹

```python
# ç¼–è¯‘ç”Ÿæˆçš„ä»£ç è°ƒç”¨
engine.add_component("MockDevice", "instance_id", config)
    â†“
# å¼•æ“å†…éƒ¨
def add_component(self, name, instance_id, config):
    component = ComponentRegistry.create(name, instance_id, config)
        â†“
    # æ³¨å†Œè¡¨æŸ¥æ‰¾å¹¶å®ä¾‹åŒ–
    component_class = _registry["MockDevice"]  # è·å–ç±»
    instance = component_class(instance_id)    # åˆ›å»ºå®ä¾‹
    instance.configure(config)                 # åº”ç”¨é…ç½®
    return instance
```

**ä¼˜åŠ¿**:
- å‰ç«¯æ— éœ€å…³å¿ƒåç«¯ç±»çš„è·¯å¾„
- æ–°å¢ç»„ä»¶åªéœ€æ·»åŠ è£…é¥°å™¨
- ç¼–è¯‘å™¨é€šè¿‡å­—ç¬¦ä¸²åç§°å³å¯åˆ›å»ºå®ä¾‹

---

## å…­ã€MQTT å®æ—¶é€šä¿¡

### 6.1 å‘å¸ƒ-è®¢é˜…æ¶æ„

```
å‰ç«¯ Dashboard (mqtt.js)
    â†“ è®¢é˜…
MQTT Broker (localhost:1883)
    â†‘ å‘å¸ƒ
åç«¯ç»„ä»¶ (paho-mqtt)

æ•°æ®æµ:
MockDevice.process()
    â†’ å‘å¸ƒåˆ° topic: "accudaq/demo/sensor"
    â†’ Broker è½¬å‘
    â†’ Dashboard è®¢é˜…å¹¶æ¥æ”¶
    â†’ Recharts å®æ—¶ç»˜å›¾
```

### 6.2 ä¸»é¢˜çº¦å®š

```python
# ç»„ä»¶é…ç½®ä¸­æŒ‡å®š topic
{
    "topic": "accudaq/demo/sensor",  # æ•°æ®å‘å¸ƒä¸»é¢˜
    "broker_host": "localhost",
    "broker_port": 1883
}

# å‰ç«¯è®¢é˜…åŒä¸€ä¸»é¢˜
const { subscribe } = useMqtt('ws://localhost:9001')
subscribe('accudaq/demo/sensor', (data) => {
    updateChart(data)
})
```

---

## ä¸ƒã€å‰åç«¯åä½œæµç¨‹æ€»ç»“

### å®Œæ•´å·¥ä½œæµ

```
1. ã€å‰ç«¯å¼€å‘ã€‘åœ¨ componentLibrary.ts å®šä¹‰ç»„ä»¶å…ƒæ•°æ®
   â”œâ”€ type: 'mock_device'
   â”œâ”€ inputs/outputs ç«¯å£
   â””â”€ propertySchema å±æ€§é…ç½®

2. ã€åç«¯å¼€å‘ã€‘å®ç°å¯¹åº”çš„ Python ç»„ä»¶
   â”œâ”€ @ComponentRegistry.register æ³¨å†Œ
   â”œâ”€ component_name = "MockDevice"
   â”œâ”€ _setup_ports() åˆ›å»ºç«¯å£
   â””â”€ process() å®ç°é€»è¾‘

3. ã€ç¼–è¯‘å™¨é…ç½®ã€‘åœ¨ NODE_TYPE_MAPPING æ·»åŠ æ˜ å°„
   "daq:mock_device": "MockDevice"

4. ã€ç”¨æˆ·æ“ä½œã€‘åœ¨å¯è§†åŒ–ç¼–è¾‘å™¨æ‹–æ‹½ç»„ä»¶
   â”œâ”€ è®¾ç½®å±æ€§ (wave_type, amplitude...)
   â”œâ”€ è¿æ¥ç«¯å£ (value â†’ input1)
   â””â”€ å¯¼å‡º .daq æ–‡ä»¶

5. ã€ç¼–è¯‘æ‰§è¡Œã€‘è¿è¡Œ compile_now.py
   â”œâ”€ è§£æ .daq â†’ DAQProject
   â”œâ”€ æ‹“æ‰‘æ’åº â†’ ç¡®å®šæ‰§è¡Œé¡ºåº
   â”œâ”€ ç”Ÿæˆä»£ç  â†’ run_realtime_app.py
   â””â”€ åŒ…å«æ‰€æœ‰ç»„ä»¶åˆ›å»ºå’Œè¿æ¥ä»£ç 

6. ã€è¿è¡Œç›‘æ§ã€‘æ‰§è¡Œç”Ÿæˆçš„è„šæœ¬
   â”œâ”€ DAQEngine åˆå§‹åŒ–ç»„ä»¶
   â”œâ”€ ä¸»å¾ªç¯ä¼ è¾“æ•°æ®
   â”œâ”€ MQTT å‘å¸ƒå®æ—¶æ•°æ®
   â””â”€ å‰ç«¯ Dashboard å¯è§†åŒ–å±•ç¤º
```

---

## å…«ã€å…³é”®è®¾è®¡äº®ç‚¹

### 8.1 ç±»å‹å®‰å…¨çš„ç«¯å£ç³»ç»Ÿ
- å‰ç«¯ TypeScript ç±»å‹å®šä¹‰
- åç«¯ Python PortType æšä¸¾
- ç¼–è¯‘æ—¶éªŒè¯è¿æ¥åˆæ³•æ€§

### 8.2 å£°æ˜å¼åˆ°å‘½ä»¤å¼è½¬æ¢
- ç”¨æˆ·æ“ä½œ: å£°æ˜å¼ (æ‹–æ‹½è¿çº¿)
- ç”Ÿæˆä»£ç : å‘½ä»¤å¼ (Python ä»£ç )
- ç¼–è¯‘å™¨å®Œæˆè½¬æ¢

### 8.3 ç»„ä»¶ç”Ÿå‘½å‘¨æœŸç®¡ç†
```
init â†’ configure â†’ start â†’ process (å¾ªç¯) â†’ stop â†’ destroy
```
æ‰€æœ‰ç»„ä»¶ç»Ÿä¸€éµå¾ªæ­¤ç”Ÿå‘½å‘¨æœŸ

### 8.4 å¯æ‰©å±•æ¶æ„
- æ–°å¢ç»„ä»¶:
  1. å‰ç«¯æ·»åŠ å®šä¹‰
  2. åç«¯ç»§æ‰¿ ComponentBase
  3. ç¼–è¯‘å™¨æ·»åŠ æ˜ å°„
  4. æ— éœ€ä¿®æ”¹å¼•æ“æ ¸å¿ƒä»£ç 

---

## ä¹ã€é¡¹ç›®æ–‡ä»¶ç»“æ„

```
accuDaq/
â”œâ”€â”€ visual-editor/              # React å‰ç«¯
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ data/
â”‚   â”‚   â”‚   â””â”€â”€ componentLibrary.ts    # â­ å‰ç«¯ç»„ä»¶å®šä¹‰
â”‚   â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”‚   â”œâ”€â”€ DAQNode.tsx           # å¯è§†åŒ–èŠ‚ç‚¹
â”‚   â”‚   â”‚   â””â”€â”€ PropertyPanel.tsx     # å±æ€§ç¼–è¾‘å™¨
â”‚   â”‚   â””â”€â”€ hooks/
â”‚   â”‚       â””â”€â”€ useMqtt.ts            # MQTT é€šä¿¡
â”‚
â”œâ”€â”€ daq_core/                   # Python åç«¯
â”‚   â”œâ”€â”€ compiler/
â”‚   â”‚   â”œâ”€â”€ parser.py           # JSON è§£æå™¨
â”‚   â”‚   â”œâ”€â”€ topology.py         # æ‹“æ‰‘æ’åº
â”‚   â”‚   â”œâ”€â”€ codegen.py          # â­ ä»£ç ç”Ÿæˆå™¨ (æ˜ å°„è¡¨)
â”‚   â”‚   â””â”€â”€ compiler.py         # ç¼–è¯‘å™¨ä¸»æµç¨‹
â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”œâ”€â”€ base.py             # â­ ç»„ä»¶åŸºç±» + æ³¨å†Œè¡¨
â”‚   â”‚   â”œâ”€â”€ mock_device.py      # â­ ç»„ä»¶å®ç°ç¤ºä¾‹
â”‚   â”‚   â”œâ”€â”€ mqtt_client.py
â”‚   â”‚   â””â”€â”€ ...
â”‚   â””â”€â”€ engine.py               # â­ è¿è¡Œå¼•æ“
â”‚
â”œâ”€â”€ test_realtime.daq           # â­ ä¸­é—´è¡¨ç¤ºæ–‡ä»¶
â””â”€â”€ run_realtime_app.py         # ç¼–è¯‘ç”Ÿæˆçš„å¯æ‰§è¡Œæ–‡ä»¶
```

---

## åã€æŠ€æœ¯éš¾ç‚¹ä¸è§£å†³æ–¹æ¡ˆ

| éš¾ç‚¹ | è§£å†³æ–¹æ¡ˆ |
|------|---------|
| å‰åç«¯ç±»å‹ä¸ä¸€è‡´ | ç»Ÿä¸€çš„ PortType æšä¸¾ + ç¼–è¯‘æ—¶æ£€æŸ¥ |
| ç»„ä»¶åŠ¨æ€åŠ è½½ | ComponentRegistry æ³¨å†Œè¡¨æ¨¡å¼ |
| æ•°æ®æµæ‰§è¡Œé¡ºåº | Kahn ç®—æ³•æ‹“æ‰‘æ’åº |
| å¾ªç¯ä¾èµ–æ£€æµ‹ | æ‹“æ‰‘æ’åºè¿‡ç¨‹ä¸­è‡ªåŠ¨æ£€æµ‹ |
| å®æ—¶æ•°æ®ä¼ è¾“ | MQTT å‘å¸ƒè®¢é˜… + WebSocket |
| é…ç½®ä¸ä»£ç åˆ†ç¦» | JSON ä¸­é—´è¡¨ç¤º + ä»£ç ç”Ÿæˆ |

---

## åä¸€ã€æ€»ç»“

accuDaq ç³»ç»Ÿé€šè¿‡**ç²¾å¿ƒè®¾è®¡çš„å››å±‚æ˜ å°„æœºåˆ¶**å®ç°äº†å‰åç«¯çš„å®Œç¾åä½œ:

1. **ç»„ä»¶å®šä¹‰å±‚**: å‰ç«¯ TypeScript å¯¹è±¡ â†” åç«¯ Python ç±»
2. **ç±»å‹æ˜ å°„å±‚**: `NODE_TYPE_MAPPING` å­—å…¸ä½œä¸ºæ¡¥æ¢
3. **æ•°æ®äº¤æ¢å±‚**: `.daq` JSON æ–‡ä»¶ä½œä¸ºä¸­é—´è¡¨ç¤º
4. **è¿è¡Œæ—¶å±‚**: ComponentRegistry åŠ¨æ€å®ä¾‹åŒ–

è¿™ç§æ¶æ„ä½¿å¾—:
- âœ… å‰ç«¯å¼€å‘è€…æ— éœ€äº†è§£ Python å®ç°ç»†èŠ‚
- âœ… åç«¯å¼€å‘è€…æ— éœ€ä¿®æ”¹å‰ç«¯ä»£ç 
- âœ… ç”¨æˆ·é€šè¿‡å¯è§†åŒ–ç•Œé¢å³å¯æ„å»ºå¤æ‚æ•°æ®æµ
- âœ… ç³»ç»Ÿå…·å¤‡é«˜åº¦å¯æ‰©å±•æ€§å’Œå¯ç»´æŠ¤æ€§

**æ ¸å¿ƒä»·å€¼**: å°†å¤æ‚çš„æ•°æ®é‡‡é›†ç¼–ç¨‹è½¬åŒ–ä¸ºç›´è§‚çš„å¯è§†åŒ–æ‹–æ‹½æ“ä½œ,åŒæ—¶ä¿æŒåº•å±‚ Python ä»£ç çš„çµæ´»æ€§å’Œæ€§èƒ½ã€‚

---

## é™„å½•

### A. ç»„ä»¶å¼€å‘ç¤ºä¾‹

å®Œæ•´å®ç°ä¸€ä¸ªæ–°ç»„ä»¶éœ€è¦ä»¥ä¸‹æ­¥éª¤:

#### A.1 å‰ç«¯å®šä¹‰ (componentLibrary.ts)
```typescript
{
    type: 'data_filter',
    name: 'Data Filter',
    category: 'logic',
    icon: 'ğŸ”',
    description: 'Filter data by threshold',
    inputs: [
        { id: 'input', name: 'Input', type: 'number' }
    ],
    outputs: [
        { id: 'output', name: 'Output', type: 'number' },
        { id: 'filtered', name: 'Filtered', type: 'boolean' }
    ],
    defaultProperties: {
        min_value: 0,
        max_value: 100
    },
    propertySchema: [
        { key: 'min_value', label: 'Min Value', type: 'number' },
        { key: 'max_value', label: 'Max Value', type: 'number' }
    ]
}
```

#### A.2 åç«¯å®ç° (components/data_filter.py)
```python
from .base import ComponentBase, ComponentRegistry, PortType, ComponentType

@ComponentRegistry.register
class DataFilterComponent(ComponentBase):
    component_name = "DataFilter"
    component_type = ComponentType.LOGIC
    component_description = "Filter data by threshold"

    def _setup_ports(self):
        self.add_input_port("input", PortType.NUMBER)
        self.add_output_port("output", PortType.NUMBER)
        self.add_output_port("filtered", PortType.BOOLEAN)

    def _on_configure(self):
        self.min_value = self.config.get('min_value', 0)
        self.max_value = self.config.get('max_value', 100)

    def start(self):
        super().start()
        # åˆå§‹åŒ–é€»è¾‘

    def process(self):
        input_value = self.get_input("input")
        if input_value is None:
            return

        # è¿‡æ»¤é€»è¾‘
        is_valid = self.min_value <= input_value <= self.max_value

        # è¾“å‡ºç»“æœ
        self.set_output("output", input_value if is_valid else None)
        self.set_output("filtered", is_valid)

    def stop(self):
        super().stop()
        # æ¸…ç†é€»è¾‘
```

#### A.3 ç¼–è¯‘å™¨æ˜ å°„ (codegen.py)
```python
NODE_TYPE_MAPPING = {
    # ... å…¶ä»–æ˜ å°„
    "daq:data_filter": "DataFilter",
}
```

---

### B. è°ƒè¯•æŠ€å·§

#### B.1 å‰ç«¯è°ƒè¯•
```typescript
// åœ¨ App.tsx ä¸­æ‰“å°èŠ‚ç‚¹çŠ¶æ€
console.log('Nodes:', nodes)
console.log('Edges:', edges)

// æŸ¥çœ‹å¯¼å‡ºçš„ JSON
const daqProject = exportToDAQ()
console.log('DAQ JSON:', JSON.stringify(daqProject, null, 2))
```

#### B.2 åç«¯è°ƒè¯•
```python
# åœ¨ç»„ä»¶ä¸­æ·»åŠ æ—¥å¿—
import logging
logger = logging.getLogger(__name__)

def process(self):
    input_val = self.get_input("input")
    logger.debug(f"Processing input: {input_val}")
    # ... å¤„ç†é€»è¾‘
```

#### B.3 ç¼–è¯‘å™¨è°ƒè¯•
```python
# åœ¨ compile_now.py ä¸­æŸ¥çœ‹ç”Ÿæˆçš„ä»£ç 
code = compiler.compile()
print("=" * 60)
print("Generated Code:")
print("=" * 60)
print(code)
```

---

### C. å¸¸è§é—®é¢˜

**Q1: å‰ç«¯ç»„ä»¶æ‹–æ‹½åä¸æ˜¾ç¤º?**
- æ£€æŸ¥ `componentLibrary.ts` ä¸­çš„ type å­—æ®µ
- ç¡®è®¤ç»„ä»¶å·²æ·»åŠ åˆ° `componentLibrary` æ•°ç»„ä¸­

**Q2: ç¼–è¯‘æ—¶æç¤ºæ‰¾ä¸åˆ°ç»„ä»¶?**
- æ£€æŸ¥ `NODE_TYPE_MAPPING` æ˜¯å¦æœ‰å¯¹åº”æ˜ å°„
- ç¡®è®¤åç«¯ç»„ä»¶å·²ä½¿ç”¨ `@ComponentRegistry.register` è£…é¥°å™¨

**Q3: è¿çº¿åæ•°æ®ä¸ä¼ è¾“?**
- æ£€æŸ¥ç«¯å£åç§°æ˜¯å¦åŒ¹é…
- ç¡®è®¤ç»„ä»¶çš„ `process()` æ–¹æ³•æ˜¯å¦è°ƒç”¨ `set_output()`
- æŸ¥çœ‹å¼•æ“çš„ `transfer_data()` æ—¥å¿—

**Q4: MQTT æ•°æ®æ”¶ä¸åˆ°?**
- ç¡®è®¤ MQTT Broker æ˜¯å¦è¿è¡Œ (mosquitto)
- æ£€æŸ¥ topic åç§°æ˜¯å¦ä¸€è‡´
- æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å° WebSocket è¿æ¥çŠ¶æ€

---

### D. æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **å‡å°‘ä¸»å¾ªç¯é¢‘ç‡**: æ ¹æ®å®é™…éœ€æ±‚è°ƒæ•´ `tick_interval_ms`
2. **æ‰¹é‡å¤„ç†æ•°æ®**: åœ¨ `process()` ä¸­ç§¯ç´¯æ•°æ®åæ‰¹é‡å¤„ç†
3. **å¼‚æ­¥ MQTT å‘å¸ƒ**: ä½¿ç”¨éé˜»å¡çš„ MQTT å®¢æˆ·ç«¯
4. **ç«¯å£ç¼“å­˜**: é¿å…é‡å¤è°ƒç”¨ `get_input()`

```python
def process(self):
    # âŒ ä½æ•ˆ: å¤šæ¬¡è°ƒç”¨
    result = self.get_input("a") + self.get_input("b")

    # âœ… é«˜æ•ˆ: ç¼“å­˜å€¼
    a = self.get_input("a")
    b = self.get_input("b")
    result = a + b if a and b else None
```

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0
**ç”Ÿæˆæ—¶é—´**: 2026-01-20
**ä½œè€…**: accuDaq å¼€å‘å›¢é˜Ÿ
