# AccuDaq 功能实现详细清单

**更新日期**: 2026-01-26

## 📊 总体统计

| 分类 | 数量 |
|------|------|
| 前端组件 | 27 个 React 组件 |
| 后端组件 | 60+ 个 Python 组件 |
| 设备协议 | 12 种协议 |
| API 端点 | 70+ 个 REST 接口 |
| 组件分类 | 7 个类别 |
| 支持数据库 | 4 种 |
| 信号处理算法 | 7 种 |

---

## 1. 前端组件 (Visual Editor - React/TypeScript)

### 核心编辑器
| 组件 | 功能描述 |
|------|----------|
| FlowDesigner | 高级流程可视化编程界面 |
| ComponentLibrary | 可拖拽组件面板，60+ 组件 |
| PropertyPanel | 动态属性编辑器 |
| DAQNode | 自定义 ReactFlow 节点，带端口可视化 |
| Toolbar | 主工具栏（文件操作、视图控制） |
| CodeView | 生成的 Python 代码查看器（语法高亮） |

### 仪表盘与可视化
| 组件 | 功能描述 |
|------|----------|
| Dashboard | 实时监控面板，MQTT 集成 |
| DashboardDesigner | 可视化仪表盘布局编辑器 |
| IndustryWidgets | 工业级控件（仪表盘、储罐、阀门、电机） |
| Widgets | 标准控件库（图表、仪表、指示灯） |

### 开发调试工具
| 组件 | 功能描述 |
|------|----------|
| DataFlowDebugger | 可视化调试器，支持断点和单步执行 |
| DebugOverlay | 运行时调试覆盖层，显示数据流 |
| BlocklyEditor | 可视化积木编程界面 |
| BlockFactory | 自定义积木创建工具 |

### 数据分析与监控
| 组件 | 功能描述 |
|------|----------|
| CommLogViewer | 通信协议日志查看器（支持过滤） |
| DataReplayPanel | 历史数据回放（支持速度控制） |
| HistoryDataViewer | 时序数据可视化和导出 |
| TaskSchedulerPanel | 可视化任务调度界面 |

### AI 与自动化
| 组件 | 功能描述 |
|------|----------|
| AIChat | AI 助手聊天界面（支持流式输出） |
| AIAssistantPanel | 高级 AI 功能（代码生成、诊断、推荐） |
| CICDPanel | CI/CD 流水线配置和监控 |
| GitPanel | Git 版本控制集成 |

### 配置与管理
| 组件 | 功能描述 |
|------|----------|
| DaqEngine | 引擎控制面板（编译/启动/停止） |
| DevicePanel | 设备配置和管理 |
| SettingsPanel | 应用设置和偏好 |
| NewProjectDialog | 项目创建向导（含模板） |

---

## 2. 后端组件 (Python - daq_core/components/)

### 设备通信组件 (14 个)

#### 串口与工业协议
| 组件 | 功能描述 |
|------|----------|
| SerialPort | RS232/485，支持 ASCII/HEX/Raw 格式，自动重连 |
| ModbusRTU | 串口 Modbus，支持多种寄存器类型 |
| ModbusTCP | 以太网 Modbus，支持 uint16/int16/float32 |

#### SCPI 与 USB
| 组件 | 功能描述 |
|------|----------|
| SCPIDevice | VISA/SCPI 仪器控制（示波器、万用表、电源） |
| USBDevice | USB 批量传输，可配置端点 |
| USBHID | USB HID 设备通信 |

#### 无线通信
| 组件 | 功能描述 |
|------|----------|
| BluetoothRFCOMM | 经典蓝牙串口通信 |
| BLEDevice | 低功耗蓝牙，支持 GATT 特征和通知 |

#### 测试与仿真
| 组件 | 功能描述 |
|------|----------|
| MockDevice | 模拟数据源（正弦/方波/随机/三角波） |

### 高级工业协议 (9 个)

#### EtherCAT
| 组件 | 功能描述 |
|------|----------|
| EtherCATMaster | 实时以太网现场总线主站 |
| EtherCATSlaveIO | 从站设备 I/O 读写 |

#### CANopen
| 组件 | 功能描述 |
|------|----------|
| CANopenMaster | CAN 网络主站（SocketCAN, PCAN, Kvaser, Vector） |
| CANopenNode | 对象字典读写 |
| CANopenPDO | 过程数据对象处理 |

#### OPC UA
| 组件 | 功能描述 |
|------|----------|
| OPCUAClient | 工业物联网客户端（带认证） |
| OPCUANodeReader | 变量轮询 |
| OPCUANodeWriter | 变量写入 |
| OPCUASubscription | 实时数据变更通知 |

### FPGA 集成 (7 个)
| 组件 | 功能描述 |
|------|----------|
| FPGADevice | PCIe/AXI FPGA 板卡管理 |
| FPGARegisterRead/Write | 内存映射寄存器访问 |
| FPGAADC | 多通道模数转换 |
| FPGADAC | 数模输出 |
| FPGAPWM | PWM 信号生成 |
| FPGADMA | 高速 DMA 传输 |

### 信号处理与算法 (7 个)
| 组件 | 功能描述 |
|------|----------|
| FFT | 快速傅里叶变换（频谱分析） |
| MovingAverageFilter | 移动平均滤波 |
| LowPassFilter | 低通滤波（去除高频噪声） |
| HighPassFilter | 高通滤波（去除低频漂移） |
| PIDController | PID 闭环控制器 |
| KalmanFilter | 卡尔曼滤波（最优状态估计） |
| Statistics | 统计计算（均值/标准差/最值） |

### 逻辑与控制流 (10 个)
| 组件 | 功能描述 |
|------|----------|
| MathOperation | 算术运算（加/减/乘/除/缩放） |
| Compare | 数值比较（支持容差） |
| ThresholdAlarm | 阈值报警检测 |
| Conditional | 条件分支（多模式 if-else） |
| WhileLoop | 周期性循环执行 |
| Timer | 定时触发器 |
| Counter | 递增/递减计数器 |
| GlobalVariable | 跨组件数据共享 |
| DebugPrint | 控制台调试输出 |
| CustomScript | Blockly 生成的 Python 代码执行 |

### 数据存储 (5 个)
| 组件 | 功能描述 |
|------|----------|
| CSVStorage | CSV 文件记录（带时间戳） |
| SQLiteStorage | 本地关系数据库（批量写入） |
| RedisCache | 内存键值存储（支持 TTL） |
| InfluxDBStorage | 时序数据库（批量写入） |
| TimescaleDBStorage | PostgreSQL 时序扩展（超表） |

### 通信组件 (2 个)
| 组件 | 功能描述 |
|------|----------|
| MQTTSubscriber | 订阅 MQTT 主题 |
| MQTTPublisher | 发布数据到 MQTT |

### 高级功能组件
| 组件 | 功能描述 |
|------|----------|
| TimedLoop | 高精度定时（过载检测） |
| RateLimiter | 数据流限速 |
| Watchdog | 超时监控 |
| CommLogger | 协议级通信日志 |
| DataReplay | 历史数据回放引擎 |
| TaskScheduler | Cron/间隔/事件驱动任务 |
| VariableBinding | 动态属性绑定 |
| PluginSystem | 自定义组件加载 |
| ReportGenerator | HTML/PDF/CSV 报告生成 |

---

## 3. 编译器架构

### 4 阶段编译流水线

```
.daq JSON → Parser → Topology Sort → Code Generator → Python 脚本
```

| 阶段 | 文件 | 功能 |
|------|------|------|
| 解析器 | `parser.py` | JSON 转内部数据结构，验证 schema |
| 拓扑排序 | `topology.py` | Kahn 算法计算执行顺序，检测循环依赖 |
| 代码生成 | `codegen.py` | 生成组件实例化代码、端口连接、主循环 |
| 编译器 | `compiler.py` | 编排整个流程，收集错误和警告 |

---

## 4. 运行时引擎 (DAQEngine)

| 功能 | 描述 |
|------|------|
| 组件生命周期 | init → configure → start → process → stop → destroy |
| 主循环 | 100ms tick 间隔 |
| 数据传输 | 自动在连接的端口间传输数据 |
| 线程安全 | 组件执行线程安全 |
| 组件注册表 | 单例模式，装饰器注册 (@ComponentRegistry.register) |

---

## 5. API 服务器 (70+ REST 端点)

### 引擎控制
- `POST /api/engine/start` - 启动 DAQ 运行时
- `POST /api/engine/stop` - 停止 DAQ 运行时
- `GET /api/engine/status` - 获取引擎状态

### 调试 API
- `GET /api/debug/state` - 获取调试状态
- `POST /api/debug/enable` - 启用调试模式
- `POST /api/debug/breakpoint` - 切换断点
- `POST /api/debug/continue` - 从断点继续

### AI/LLM 集成
- `POST /api/ai/chat` - 非流式 AI 聊天
- `POST /api/ai/chat/stream` - 流式 AI 响应
- `POST /api/ai/assistant/generate-code` - 代码生成
- `POST /api/ai/assistant/diagnose` - 错误诊断
- `POST /api/ai/assistant/recommend` - 组件推荐

### 通信日志
- `GET /api/logs` - 查询日志（支持过滤）
- `GET /api/logs/export` - 导出 JSON/CSV

### 历史数据
- `GET /api/history/query` - 时间范围查询
- `GET /api/history/aggregate` - 聚合统计
- `GET /api/history/export` - CSV 导出

### 任务调度
- `GET/POST /api/tasks` - 任务 CRUD
- `POST /api/tasks/<id>/pause|resume` - 暂停/恢复

### 数据回放
- `POST /api/replay/load` - 加载 CSV/JSON 数据
- `POST /api/replay/play|pause|stop` - 播放控制
- `POST /api/replay/speed` - 调整播放速度

### CI/CD 自动化
- `GET /api/cicd/pipelines` - 列出流水线
- `POST /api/cicd/template` - 从模板创建
- `POST /api/cicd/export` - 导出配置（GitHub/GitLab/Jenkins）

### 云部署
- `POST /api/deploy/prepare` - 准备 Docker/K8s 文件
- `POST /api/deploy/execute` - 执行部署

---

## 6. 项目文件格式 (.daq JSON)

```json
{
  "meta": { "name": "项目名", "version": "1.0.0", "schemaVersion": "2.0.0" },
  "devices": [ { "id": "...", "protocol": "modbus", "config": {...} } ],
  "logic": {
    "nodes": [ { "id": "...", "type": "daq:mock_device", "position": {...} } ],
    "wires": [ { "source": {...}, "target": {...} } ]
  },
  "ui": { "widgets": [ { "id": "...", "type": "gauge", "binding": {...} } ] }
}
```

---

## 7. 支持的协议与数据库

### 设备协议
| 协议 | 类型 |
|------|------|
| RS232/485 | 串口 |
| Modbus RTU/TCP | 工业协议 |
| SCPI/VISA | 仪器控制 |
| USB Bulk/HID | USB 设备 |
| Bluetooth/BLE | 无线 |
| EtherCAT | 实时以太网 |
| CANopen | CAN 总线 |
| OPC UA | 工业物联网 |
| FPGA PCIe/AXI | 硬件加速 |

### 数据库支持
| 数据库 | 用途 |
|--------|------|
| SQLite | 本地关系存储 |
| Redis | 内存缓存 |
| InfluxDB | 时序数据 |
| TimescaleDB | PostgreSQL 时序扩展 |

---

## 8. MVP 验收标准 ✅

| 步骤 | 要求 | 状态 |
|------|------|------|
| 1 | 新建"温度监控"项目 | ✅ 完成 |
| 2 | 添加"虚拟温度传感器" | ✅ 完成 |
| 3 | 拖入"读取"和"大于"节点 | ✅ 完成 |
| 4 | 拖入"波形图"和"报警灯" | ✅ 完成 |
| 5 | 运行并看到波形图、报警灯 | ✅ 完成 |
| 6 | 找到保存的 CSV 数据 | ✅ 完成 |

---

## 9. 单元测试状态

**测试结果: 30/30 通过 (100%)**

| 测试类别 | 通过/总数 |
|----------|-----------|
| 编译器测试 | 4/4 |
| Timer 组件测试 | 4/4 |
| Counter 组件测试 | 5/5 |
| 组件注册表测试 | 2/2 |
| MVP 工作流测试 | 9/9 |
| MVP 组件测试 | 4/4 |

---

## 10. 技术栈

### 前端
- React 18 + TypeScript
- @xyflow/react v12 (流程图)
- Recharts (图表)
- MQTT.js (实时通信)
- Vite (构建工具)
- react-grid-layout (仪表盘布局)

### 后端
- Python 3.12
- Flask (REST API)
- paho-mqtt (MQTT 客户端)
- pymodbus (Modbus 协议)
- pytest (单元测试)

### 架构
- 编译器架构 (Parser → Topology → CodeGen)
- 组件注册表模式
- 端口系统 (类型化输入/输出)
- MQTT 消息总线

---

## 总结

**accuDaq** 是一个**生产级工业数据采集系统**，具备以下特点：

- 🎨 **可视化编程** - 类似 LabVIEW 的拖拽式流程编辑
- ⚡ **实时通信** - MQTT 双向数据流
- 🏭 **工业级协议** - Modbus、EtherCAT、CANopen、OPC UA
- 🔧 **编译架构** - .daq JSON → Python 可执行代码
- 🤖 **AI 辅助** - 代码生成、错误诊断、组件推荐
- 📊 **数据分析** - 历史数据、回放、报告生成
- 🚀 **DevOps 集成** - Git、CI/CD、Docker/K8s 部署
- ✅ **测试覆盖** - 30/30 单元测试通过

---

*文档生成时间: 2026-01-26*
