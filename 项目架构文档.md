# accuDaq 项目架构文档

## 📋 项目概述

**accuDaq** 是一个可视化数据采集与处理系统（Data Acquisition System），采用编译器架构，支持通过可视化界面拖拽组件构建数据流，并将其编译为可执行的 Python 代码。

### 核心特性
- 🎨 **可视化编辑器**：基于 React + XYFlow 的拖拽式流程编辑
- 🔧 **编译器架构**：将 `.daq` JSON 配置文件编译为可执行 Python 代码
- 🧩 **组件化设计**：插件式组件系统，支持设备、逻辑、存储等多种类型
- 📊 **实时监控**：Dashboard 实时显示数据流状态
- 🔌 **MQTT 通信**：支持 MQTT 协议进行数据采集和发布

---

## 🏗️ 项目结构

```
accuDaq/
├── daq_core/                    # 核心引擎和编译器（Python）
│   ├── compiler/                # 编译器模块
│   │   ├── parser.py           # .daq 文件解析器
│   │   ├── compiler.py         # 编译器主入口
│   │   ├── topology.py         # 拓扑排序（依赖分析）
│   │   └── codegen.py          # Python 代码生成器
│   ├── components/              # 组件库
│   │   ├── base.py             # 组件基类和注册表
│   │   ├── mock_device.py      # 模拟设备组件
│   │   ├── mqtt_client.py      # MQTT 订阅组件
│   │   ├── mqtt_publisher.py   # MQTT 发布组件
│   │   ├── math_ops.py         # 数学运算组件
│   │   └── csv_storage.py      # CSV 存储组件
│   ├── engine.py                # DAQ 运行时引擎
│   └── examples/                # 示例代码
│
├── visual-editor/               # 可视化编辑器（React + TypeScript）
│   ├── src/
│   │   ├── components/          # React 组件
│   │   │   ├── ComponentLibrary.tsx   # 组件库面板
│   │   │   ├── DAQNode.tsx            # 流程图节点
│   │   │   ├── PropertyPanel.tsx      # 属性编辑面板
│   │   │   ├── Toolbar.tsx            # 工具栏
│   │   │   ├── Dashboard.tsx          # 实时监控面板
│   │   │   ├── DaqEngine.tsx          # 引擎控制面板
│   │   │   └── widgets/               # 数据可视化组件
│   │   │       ├── LineChartWidget.tsx  # 折线图
│   │   │       └── GaugeWidget.tsx      # 仪表盘
│   │   ├── hooks/
│   │   │   └── useMqtt.ts       # MQTT 连接 Hook
│   │   ├── data/
│   │   │   └── componentLibrary.ts  # 组件定义
│   │   ├── types.ts             # TypeScript 类型定义
│   │   ├── App.tsx              # 主应用组件
│   │   └── main.tsx             # 应用入口
│   ├── package.json
│   └── vite.config.ts
│
├── vscode-extension/            # VS Code 扩展（可选）
│   ├── src/
│   │   ├── extension.ts         # 扩展主入口
│   │   ├── compiler.ts          # 编译器集成
│   │   ├── executor.ts          # 代码执行器
│   │   └── projectManager.ts    # 项目管理
│   └── syntaxes/
│       └── daq.tmLanguage.json  # .daq 文件语法高亮
│
├── architecture/                # 架构设计文档
│   ├── daq_project_schema.json  # .daq 文件 Schema 定义
│   └── samples/                 # 示例项目
│       └── mvp_temperature_monitor.json
│
├── data/                        # 运行时数据存储目录
├── examples/                    # 生成的示例代码
├── compile_now.py               # 快速编译脚本
├── run_realtime_app.py          # 编译生成的运行脚本
└── test_realtime.daq            # 测试项目文件

```

---

## 🔧 核心模块详解

### 1️⃣ **DAQ Core（daq_core/）**

#### 1.1 编译器模块（compiler/）

##### **parser.py** - 项目文件解析器
```python
功能：将 .daq JSON 文件解析为内部数据结构
核心类：
  - DAQProject: 项目数据模型
  - Node: 节点定义（包含位置、类型、属性）
  - Wire: 连线定义（source → target）
  - Device: 设备配置
  - Widget: UI 控件定义
  - DAQProjectParser: 解析器主类

流程：
  1. 读取 .daq 文件（JSON 格式）
  2. 验证 schema 版本
  3. 解析 meta、devices、logic、ui 四大部分
  4. 返回 DAQProject 对象
```

##### **topology.py** - 拓扑排序
```python
功能：分析节点依赖关系，确定执行顺序
核心算法：
  - 基于 Kahn 算法的拓扑排序
  - 循环依赖检测
  - 连接有效性验证

作用：确保组件按照数据流方向正确执行
```

##### **codegen.py** - 代码生成器
```python
功能：将解析后的项目转换为可执行的 Python 脚本
生成内容：
  - 导入语句（根据使用的组件自动生成）
  - 引擎初始化代码
  - 组件创建和配置
  - 组件间连接
  - MQTT 回调函数
  - 主函数（启动/停止逻辑）

输出：完整的 Python 脚本，可直接运行
```

##### **compiler.py** - 编译器主入口
```python
功能：集成解析、拓扑排序、代码生成三大步骤
接口：
  - compile_file(input_path, output_path): 编译 .daq 文件
  - compile_string(json_string): 编译 JSON 字符串
  - get_errors(): 获取编译错误
  - get_warnings(): 获取警告信息

编译流程：
  解析 → 拓扑排序 → 验证连接 → 生成代码 → 保存文件
```

---

#### 1.2 组件库（components/）

##### **base.py** - 组件基础框架
```python
核心类：
  - ComponentBase: 所有组件的抽象基类
  - Port: 组件端口定义（输入/输出）
  - ComponentRegistry: 组件注册表（单例模式）

组件生命周期：
  init → configure → start → process → stop → destroy

端口系统：
  - 输入端口：接收数据
  - 输出端口：输出数据
  - 类型：number, string, boolean, object, array, any
```

##### **mock_device.py** - 模拟设备组件
```python
功能：生成模拟传感器数据（用于测试）
支持波形：
  - sine: 正弦波
  - square: 方波
  - random: 随机值

配置参数：
  - wave_type: 波形类型
  - amplitude: 振幅
  - frequency: 频率
  - interval_ms: 采样间隔
  - broker_host/port/topic: MQTT 发布配置
```

##### **mqtt_client.py** - MQTT 订阅组件
```python
功能：订阅 MQTT 主题，接收外部数据
端口：
  - 输出: data（接收到的消息）

配置：
  - broker_host: MQTT Broker 地址
  - broker_port: 端口（默认 1883）
  - topic: 订阅主题
```

##### **mqtt_publisher.py** - MQTT 发布组件
```python
功能：将处理后的数据发布到 MQTT 主题
端口：
  - 输入: data（要发布的数据）

用途：将数据推送给 Dashboard 或其他订阅者
```

##### **math_ops.py** - 数学运算组件
```python
功能：对数据进行数学变换
支持操作：
  - scale: y = x * scale + offset（缩放和偏移）
  - add/subtract/multiply/divide（四则运算）

端口：
  - 输入: input1, input2（取决于操作类型）
  - 输出: result
```

##### **csv_storage.py** - CSV 存储组件
```python
功能：将数据保存到 CSV 文件
端口：
  - 输入: value（要保存的数据）

配置：
  - file_path: CSV 文件路径
  - include_timestamp: 是否包含时间戳
```

---

#### 1.3 运行时引擎（engine.py）

##### **DAQEngine** - 核心调度引擎
```python
功能：管理组件生命周期，协调数据流传输

核心方法：
  - add_component(name, id, config): 创建组件实例
  - connect(source_id, source_port, target_id, target_port): 建立连接
  - start(): 启动所有组件
  - stop(): 停止所有组件
  - _main_loop(): 主循环（周期性触发 process）
  - _transfer_data(): 在连接间传输数据

主循环逻辑：
  1. 传输数据（根据连线关系）
  2. 触发组件 process() 方法
  3. 等待 tick_interval（默认 100ms）
```

---

### 2️⃣ **Visual Editor（visual-editor/）**

#### 2.1 核心组件

##### **App.tsx** - 主应用
```typescript
功能：整合所有子组件，管理应用状态
状态管理：
  - nodes: 流程图节点列表
  - edges: 连线列表
  - selectedNode: 当前选中节点
  - projectMeta: 项目元信息

布局：左侧组件库 + 中央画布 + 右侧属性面板 + 底部 Dashboard
```

##### **ComponentLibrary.tsx** - 组件库面板
```typescript
功能：显示可用组件，支持拖拽
组件分类：
  - 设备组件（Device）
  - 通信组件（Communication）
  - 逻辑组件（Logic）
  - 存储组件（Storage）

交互：拖拽组件到画布自动创建节点
```

##### **DAQNode.tsx** - 流程图节点
```typescript
功能：自定义 ReactFlow 节点组件
特性：
  - 显示组件图标和名称
  - Handle（连接点）定义输入/输出
  - 选中高亮效果
```

##### **PropertyPanel.tsx** - 属性编辑面板
```typescript
功能：编辑选中节点的配置参数
动态表单：根据组件类型显示不同的配置项
实时更新：修改后立即同步到节点数据
```

##### **Dashboard.tsx** - 实时监控面板
```typescript
功能：显示运行时数据
支持组件：
  - LineChartWidget: 折线图（时序数据）
  - GaugeWidget: 仪表盘（当前值）

数据源：订阅 MQTT 主题获取实时数据
```

##### **DaqEngine.tsx** - 引擎控制
```typescript
功能：控制 DAQ 引擎的启动/停止/编译
操作：
  - 编译项目（生成 .daq 文件）
  - 启动引擎（调用 Python 后端）
  - 停止引擎
```

##### **Toolbar.tsx** - 工具栏
```typescript
功能：项目操作按钮
操作：
  - 新建项目
  - 保存/加载项目
  - 导出 .daq 文件
  - 运行/停止
```

---

#### 2.2 Hooks

##### **useMqtt.ts** - MQTT 连接管理
```typescript
功能：封装 MQTT.js，提供 React Hook 接口
提供：
  - connect(): 连接 MQTT Broker
  - subscribe(topic): 订阅主题
  - publish(topic, message): 发布消息
  - disconnect(): 断开连接
  - messages: 接收到的消息列表
```

---

#### 2.3 数据定义

##### **types.ts** - TypeScript 类型定义
```typescript
核心类型：
  - DAQNode: 流程图节点
  - DAQEdge: 连线
  - ComponentDef: 组件定义
  - ProjectMeta: 项目元信息
  - WidgetConfig: 控件配置
```

##### **componentLibrary.ts** - 组件库配置
```typescript
定义所有可用组件的元信息：
  - id, name, type
  - inputs, outputs（端口定义）
  - properties（可配置参数）
  - icon（显示图标）
```

---

### 3️⃣ **VS Code Extension（vscode-extension/）**

##### **extension.ts** - 扩展入口
```typescript
功能：VS Code 扩展激活入口
注册命令：
  - 创建新项目
  - 编译 .daq 文件
  - 运行项目
```

##### **compiler.ts** - 编译器集成
```typescript
功能：调用 Python 编译器
流程：执行 compile_now.py → 生成运行脚本
```

##### **executor.ts** - 代码执行器
```typescript
功能：在终端中运行生成的 Python 脚本
```

##### **projectManager.ts** - 项目管理
```typescript
功能：管理 .daq 项目文件的创建、读取、保存
```

---

## 📊 数据流架构

### 编译时流程
```
.daq 文件（JSON）
    ↓
Parser（解析器）
    ↓
DAQProject（内部数据结构）
    ↓
TopologySort（拓扑排序）
    ↓
CodeGenerator（代码生成）
    ↓
run_*.py（可执行 Python 脚本）
```

### 运行时流程
```
DAQEngine.start()
    ↓
启动所有组件
    ↓
主循环（100ms 周期）
    ├─ 传输数据（按连线关系）
    ├─ 触发组件 process()
    └─ 等待下一周期
    ↓
组件输出 → MQTT 发布 → Dashboard 显示
```

### 可视化编辑流程
```
用户拖拽组件到画布
    ↓
创建 DAQNode 实例
    ↓
配置属性（PropertyPanel）
    ↓
连接节点（创建 Edge）
    ↓
导出为 .daq JSON 文件
    ↓
编译器编译
    ↓
生成可执行代码
```

---

## 🗂️ 核心文件作用清单

### Python 核心文件

| 文件路径 | 作用 |
|---------|------|
| `daq_core/compiler/parser.py` | 解析 .daq JSON 文件，转换为内部数据结构 |
| `daq_core/compiler/compiler.py` | 编译器主入口，协调解析、排序、生成流程 |
| `daq_core/compiler/topology.py` | 拓扑排序，分析依赖关系，检测循环 |
| `daq_core/compiler/codegen.py` | 生成可执行的 Python 代码 |
| `daq_core/engine.py` | DAQ 运行时引擎，管理组件生命周期和数据流 |
| `daq_core/components/base.py` | 组件基类、端口系统、组件注册表 |
| `daq_core/components/mock_device.py` | 模拟设备组件（生成测试数据） |
| `daq_core/components/mqtt_client.py` | MQTT 订阅组件 |
| `daq_core/components/mqtt_publisher.py` | MQTT 发布组件 |
| `daq_core/components/math_ops.py` | 数学运算组件（缩放、四则运算） |
| `daq_core/components/csv_storage.py` | CSV 存储组件 |
| `compile_now.py` | 快速编译脚本（编译 test_realtime.daq） |
| `run_realtime_app.py` | 编译生成的可执行脚本 |

### TypeScript/React 文件

| 文件路径 | 作用 |
|---------|------|
| `visual-editor/src/App.tsx` | 主应用组件，整合画布、属性面板、Dashboard |
| `visual-editor/src/components/ComponentLibrary.tsx` | 组件库面板，支持拖拽 |
| `visual-editor/src/components/DAQNode.tsx` | 自定义流程图节点组件 |
| `visual-editor/src/components/PropertyPanel.tsx` | 属性编辑面板 |
| `visual-editor/src/components/Toolbar.tsx` | 工具栏（保存、编译、运行） |
| `visual-editor/src/components/Dashboard.tsx` | 实时数据监控面板 |
| `visual-editor/src/components/DaqEngine.tsx` | 引擎控制面板 |
| `visual-editor/src/components/widgets/LineChartWidget.tsx` | 折线图组件 |
| `visual-editor/src/components/widgets/GaugeWidget.tsx` | 仪表盘组件 |
| `visual-editor/src/hooks/useMqtt.ts` | MQTT 连接 Hook |
| `visual-editor/src/types.ts` | TypeScript 类型定义 |
| `visual-editor/src/data/componentLibrary.ts` | 组件库配置数据 |
| `visual-editor/src/main.tsx` | React 应用入口 |

### VS Code 扩展文件

| 文件路径 | 作用 |
|---------|------|
| `vscode-extension/src/extension.ts` | 扩展主入口，注册命令 |
| `vscode-extension/src/compiler.ts` | 编译器集成（调用 Python 编译器） |
| `vscode-extension/src/executor.ts` | 代码执行器 |
| `vscode-extension/src/projectManager.ts` | 项目文件管理 |
| `vscode-extension/syntaxes/daq.tmLanguage.json` | .daq 文件语法高亮定义 |

### 配置和文档文件

| 文件路径 | 作用 |
|---------|------|
| `architecture/daq_project_schema.json` | .daq 文件的 JSON Schema 定义 |
| `architecture/samples/mvp_temperature_monitor.json` | 示例项目文件 |
| `test_realtime.daq` | 测试项目（MQTT 实时数据流） |
| `visual-editor/package.json` | 前端依赖配置 |
| `visual-editor/vite.config.ts` | Vite 构建配置 |
| `daq_core/requirements.txt` | Python 依赖列表 |

---

## 🔄 关键设计模式

### 1. **编译器模式**
将可视化配置编译为可执行代码，而非直接解释执行
- 优势：性能高、可调试、可版本控制

### 2. **组件注册表模式**
通过 `ComponentRegistry` 单例管理所有组件
- 优势：解耦、易扩展、支持插件化

### 3. **端口连接模式**
组件通过标准化的输入/输出端口通信
- 优势：松耦合、可重用、易于可视化

### 4. **拓扑排序**
编译时分析依赖关系，确定执行顺序
- 优势：避免死锁、检测循环依赖

### 5. **发布-订阅模式**
使用 MQTT 作为组件间通信总线
- 优势：解耦、异步、支持分布式

---

## 🚀 使用流程

### 1. 可视化编辑
```bash
cd visual-editor
npm install
npm run dev
# 打开浏览器，拖拽组件，连接节点，配置属性
```

### 2. 编译项目
```bash
python compile_now.py
# 输入：test_realtime.daq
# 输出：run_realtime_app.py
```

### 3. 运行项目
```bash
python run_realtime_app.py
# 启动 DAQ 引擎，开始数据采集和处理
```

### 4. 查看 Dashboard
```bash
# 在可视化编辑器中打开 Dashboard 标签页
# 实时查看数据流状态和图表
```

---

## 📦 依赖关系

### Python 依赖
```
paho-mqtt       # MQTT 客户端
```

### TypeScript 依赖
```
react           # UI 框架
@xyflow/react   # 流程图组件
mqtt            # MQTT 客户端
recharts        # 图表库
uuid            # UUID 生成
```

---

## 🎯 扩展点

### 添加新组件
1. 在 `daq_core/components/` 创建新文件
2. 继承 `ComponentBase`
3. 实现 `_setup_ports()`、`start()`、`stop()`、`process()`
4. 使用 `@ComponentRegistry.register` 注册
5. 在 `componentLibrary.ts` 添加前端定义

### 添加新节点类型
1. 在 `codegen.py` 的 `NODE_TYPE_MAPPING` 添加映射
2. 在 `componentLibrary.ts` 添加组件定义
3. 更新 `daq_project_schema.json`

---

## 📝 总结

accuDaq 是一个完整的低代码 DAQ 系统，采用**编译器 + 运行时引擎**的架构，实现了从可视化编辑到代码生成的完整闭环。项目分为三大部分：

1. **daq_core**：Python 后端，包含编译器和运行时引擎
2. **visual-editor**：React 前端，提供可视化编辑和监控
3. **vscode-extension**：VS Code 集成，提升开发体验

核心优势：
- ✅ 可视化编程，降低使用门槛
- ✅ 编译为 Python 代码，性能高、易调试
- ✅ 组件化设计，易于扩展
- ✅ 实时监控，提供即时反馈
- ✅ 支持 MQTT 协议，适配工业场景

---

**生成时间**: 2026-01-19
**版本**: 1.0.0
**作者**: accuDaq Team
