<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>MQTT over WebSocket - æ ‡å‡†æ–¹æ¡ˆæ¼”ç¤º</title>
    <!-- ä» CDN å¼•å…¥ mqtt.js åº“ -->
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 30px;
            color: #fff;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            margin-bottom: 10px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .subtitle {
            text-align: center;
            margin-bottom: 30px;
            opacity: 0.9;
            font-size: 1.1em;
        }

        .connection-panel {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 1.2em;
        }

        .status-dot {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #ffc107;
            box-shadow: 0 0 15px currentColor;
            animation: pulse 2s infinite;
        }

        .status-dot.connected {
            background: #4caf50;
            color: #4caf50;
        }

        .status-dot.disconnected {
            background: #f44336;
            color: #f44336;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .info-box {
            background: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            font-size: 14px;
            font-family: monospace;
        }

        .info-box .label {
            color: #ffc107;
            font-weight: bold;
        }

        .topics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 24px;
            margin-top: 30px;
        }

        .topic-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 24px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: transform 0.2s;
        }

        .topic-card:hover {
            transform: translateY(-4px);
        }

        .topic-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .topic-icon {
            font-size: 2em;
        }

        .topic-name {
            flex: 1;
        }

        .topic-name h3 {
            font-size: 1.4em;
            margin-bottom: 4px;
        }

        .topic-path {
            font-family: monospace;
            font-size: 13px;
            opacity: 0.8;
            background: rgba(0, 0, 0, 0.2);
            padding: 4px 8px;
            border-radius: 4px;
        }

        .message-count {
            background: rgba(76, 175, 80, 0.3);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: bold;
        }

        .latest-data {
            background: rgba(0, 0, 0, 0.3);
            padding: 16px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 12px;
        }

        .latest-data pre {
            margin: 0;
            white-space: pre-wrap;
            word-wrap: break-word;
            color: #4ade80;
        }

        .no-data {
            color: #94a3b8;
            font-style: italic;
        }

        .timestamp {
            color: #ffc107;
            font-size: 11px;
            margin-bottom: 8px;
        }

        .code-example {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            padding: 20px;
            margin-top: 30px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .code-example h3 {
            color: #4fc3f7;
            margin-bottom: 12px;
        }

        .code-example pre {
            background: #1e1e1e;
            padding: 16px;
            border-radius: 8px;
            overflow-x: auto;
            font-size: 13px;
            line-height: 1.6;
        }

        .code-example code {
            color: #d4d4d4;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>ğŸš€ MQTT over WebSocket</h1>
        <div class="subtitle">å•ä¸ªè¿æ¥ + å¤šä¸»é¢˜è®¢é˜… - æ ‡å‡†æ–¹æ¡ˆæ¼”ç¤º</div>

        <!-- è¿æ¥çŠ¶æ€é¢æ¿ -->
        <div class="connection-panel">
            <div class="connection-status">
                <div class="status-dot" id="status-dot"></div>
                <div>
                    <strong id="status-text">æ­£åœ¨è¿æ¥...</strong>
                    <div style="font-size: 0.85em; opacity: 0.8; margin-top: 4px;" id="status-detail">
                        åˆå§‹åŒ– MQTT å®¢æˆ·ç«¯
                    </div>
                </div>
            </div>
            <div class="info-box">
                <div><span class="label">WebSocket åœ°å€:</span> ws://localhost:8083/mqtt</div>
                <div><span class="label">è®¢é˜…ä¸»é¢˜:</span> modbus/data, sensor/sine_wave, opcUa/data</div>
                <div><span class="label">ä½¿ç”¨åº“:</span> mqtt.js (from CDN)</div>
                <div><span class="label">ä¼˜åŠ¿:</span> âœ… å•è¿æ¥ âœ… æ ‡å‡†åè®® âœ… çµæ´»è®¢é˜… âœ… é«˜æ€§èƒ½</div>
            </div>
        </div>

        <!-- ä¸»é¢˜æ•°æ®å±•ç¤º -->
        <div class="topics-grid">
            <!-- Modbus æ•°æ® -->
            <div class="topic-card">
                <div class="topic-header">
                    <div class="topic-icon">âš¡</div>
                    <div class="topic-name">
                        <h3>Modbus TCP æ•°æ®</h3>
                        <div class="topic-path">modbus/data</div>
                    </div>
                    <div class="message-count" id="count-modbus">0 æ¡æ¶ˆæ¯</div>
                </div>
                <div class="latest-data">
                    <div class="no-data" id="data-modbus">ç­‰å¾…æ•°æ®...</div>
                </div>
            </div>

            <!-- æ­£å¼¦æ³¢æ•°æ® -->
            <div class="topic-card">
                <div class="topic-header">
                    <div class="topic-icon">ğŸ“ˆ</div>
                    <div class="topic-name">
                        <h3>æ­£å¼¦æ³¢æ¨¡æ‹Ÿæ•°æ®</h3>
                        <div class="topic-path">sensor/sine_wave</div>
                    </div>
                    <div class="message-count" id="count-sine">0 æ¡æ¶ˆæ¯</div>
                </div>
                <div class="latest-data">
                    <div class="no-data" id="data-sine">ç­‰å¾…æ•°æ®...</div>
                </div>
            </div>

            <!-- OPC UA æ•°æ® -->
            <div class="topic-card" style="border-color: rgba(255, 193, 7, 0.5);">
                <div class="topic-header">
                    <div class="topic-icon">ğŸ­</div>
                    <div class="topic-name">
                        <h3>OPC UA æ•°æ®</h3>
                        <div class="topic-path">opcua/#</div>
                    </div>
                    <div class="message-count" id="count-opcua">0 æ¡æ¶ˆæ¯</div>
                </div>
                <div class="latest-data">
                    <div class="no-data" id="data-opcua">ç­‰å¾…æ•°æ®... (éœ€å¯åŠ¨ OPC UA æ¨¡æ‹Ÿå™¨)</div>
                </div>
            </div>
        </div>

        <!-- ä»£ç ç¤ºä¾‹ -->
        <div class="code-example">
            <h3>ğŸ’» å‰ç«¯é›†æˆä»£ç ç¤ºä¾‹ï¼ˆç¬¬ä¸‰æ–¹å‚è€ƒï¼‰</h3>
            <pre><code>// 1. å¼•å…¥ mqtt.js åº“
import mqtt from 'mqtt';  // æˆ–ä½¿ç”¨ CDN: &lt;script src="https://unpkg.com/mqtt/dist/mqtt.min.js"&gt;&lt;/script&gt;

// 2. è¿æ¥åˆ° MQTT Broker (å•ä¸ªè¿æ¥)
const client = mqtt.connect('ws://localhost:8083/mqtt');

// 3. ç›‘å¬è¿æ¥æˆåŠŸäº‹ä»¶
client.on('connect', () => {
    console.log('å·²è¿æ¥åˆ° MQTT Broker');
    
    // 4. è®¢é˜…å¤šä¸ªä¸»é¢˜ï¼ˆåŒä¸€ä¸ªè¿æ¥å†…ï¼‰
    client.subscribe('modbus/data');        // Modbus è®¾å¤‡æ•°æ®
    client.subscribe('sensor/sine_wave');   // æ¨¡æ‹Ÿä¼ æ„Ÿå™¨æ•°æ®
    client.subscribe('opcua/#');            // OPC UA æ•°æ® (é€šé…ç¬¦)
    // å¯ä»¥ç»§ç»­æ·»åŠ æ›´å¤šä¸»é¢˜..
});

// 5. ç›‘å¬æ¶ˆæ¯ï¼ˆæ‰€æœ‰è®¢é˜…çš„ä¸»é¢˜éƒ½é€šè¿‡è¿™ä¸ªå›è°ƒï¼‰
client.on('message', (topic, message) => {
    const data = JSON.parse(message.toString());
    
    // 6. æ ¹æ®ä¸»é¢˜åŒºåˆ†å¤„ç†
    if (topic === 'modbus/data') {
        console.log('Modbus æ•°æ®:', data);
    } else if (topic === 'sensor/sine_wave') {
        console.log('ä¼ æ„Ÿå™¨æ•°æ®:', data);
    } else if (topic.startsWith('opcua/')) {
        console.log('OPC UA æ•°æ®:', data);
    }
});

// 7. é”™è¯¯å¤„ç†
client.on('error', (err) => {
    console.error('MQTT é”™è¯¯:', err);
});</code></pre>
        </div>
    </div>

    <script>
        // ========== MQTT å®¢æˆ·ç«¯åˆå§‹åŒ– ==========
        const BROKER_URL = 'ws://localhost:8083/mqtt';
        const TOPICS = {
            modbus: 'modbus/data',
            sine: 'sensor/sine_wave',
            opcData: 'opcUa/data'    // OPC UA æ•°æ®ä¸»é¢˜
        };

        // æ¶ˆæ¯è®¡æ•°å™¨
        const messageCount = {
            modbus: 0,
            sine: 0,
            opcua: 0
        };

        // UI å…ƒç´ 
        const statusDot = document.getElementById('status-dot');
        const statusText = document.getElementById('status-text');
        const statusDetail = document.getElementById('status-detail');

        // åˆ›å»º MQTT å®¢æˆ·ç«¯ï¼ˆå•ä¸ªè¿æ¥ï¼‰
        console.log('æ­£åœ¨è¿æ¥åˆ° MQTT Broker:', BROKER_URL);
        const client = mqtt.connect(BROKER_URL);

        // ========== è¿æ¥äº‹ä»¶å¤„ç† ==========
        client.on('connect', () => {
            console.log('âœ… å·²è¿æ¥åˆ° MQTT Broker');
            statusDot.className = 'status-dot connected';
            statusText.textContent = 'âœ… å·²è¿æ¥';
            statusDetail.textContent = `å·²è¿æ¥åˆ° ${BROKER_URL}ï¼Œæ­£åœ¨è®¢é˜…ä¸»é¢˜...`;

            // è®¢é˜…å¤šä¸ªä¸»é¢˜ï¼ˆåœ¨åŒä¸€ä¸ªè¿æ¥å†…ï¼‰
            Object.values(TOPICS).forEach(topic => {
                client.subscribe(topic, (err) => {
                    if (!err) {
                        console.log(`âœ… å·²è®¢é˜…ä¸»é¢˜: ${topic}`);
                    } else {
                        console.error(`âŒ è®¢é˜…å¤±è´¥: ${topic}`, err);
                    }
                });
            });

            statusDetail.textContent = `å·²è®¢é˜… ${Object.keys(TOPICS).length} ä¸ªä¸»é¢˜ï¼Œç­‰å¾…æ•°æ®...`;
        });

        // ========== æ¶ˆæ¯æ¥æ”¶å¤„ç† ==========
        client.on('message', (topic, message) => {
            try {
                const data = JSON.parse(message.toString());
                console.log(`ğŸ“¨ æ”¶åˆ°æ¶ˆæ¯ [${topic}]:`, data);

                // æ ¹æ®ä¸»é¢˜åˆ†å‘åˆ°ä¸åŒçš„å¤„ç†å‡½æ•°
                if (topic === TOPICS.modbus) {
                    handleModbusData(data);
                } else if (topic === TOPICS.sine) {
                    handleSineData(data);
                } else if (topic === 'opcUa/data') {
                    handleOpcuaData(topic, data);
                }

            } catch (e) {
                console.error('æ¶ˆæ¯è§£æé”™è¯¯:', e);
            }
        });

        // ========== é”™è¯¯å¤„ç† ==========
        client.on('error', (err) => {
            console.error('âŒ MQTT é”™è¯¯:', err);
            statusDot.className = 'status-dot disconnected';
            statusText.textContent = 'âŒ è¿æ¥é”™è¯¯';
            statusDetail.textContent = err.message;
        });

        client.on('close', () => {
            console.log('âš ï¸ è¿æ¥å·²æ–­å¼€');
            statusDot.className = 'status-dot disconnected';
            statusText.textContent = 'âš ï¸ è¿æ¥æ–­å¼€';
            statusDetail.textContent = 'å°è¯•é‡æ–°è¿æ¥...';
        });

        // ========== æ•°æ®å¤„ç†å‡½æ•° ==========
        function handleModbusData(data) {
            messageCount.modbus++;
            document.getElementById('count-modbus').textContent = `${messageCount.modbus} æ¡æ¶ˆæ¯`;

            const container = document.getElementById('data-modbus');
            const timestamp = new Date().toLocaleTimeString('zh-CN', { hour12: false });

            container.innerHTML = `
                <div class="timestamp">â±ï¸ ${timestamp}</div>
                <pre>${JSON.stringify(data, null, 2)}</pre>
            `;
        }

        function handleSineData(data) {
            messageCount.sine++;
            document.getElementById('count-sine').textContent = `${messageCount.sine} æ¡æ¶ˆæ¯`;

            const container = document.getElementById('data-sine');
            const timestamp = new Date().toLocaleTimeString('zh-CN', { hour12: false });

            container.innerHTML = `
                <div class="timestamp">â±ï¸ ${timestamp}</div>
                <pre>${JSON.stringify(data, null, 2)}</pre>
            `;
        }

        function handleOpcuaData(topic, data) {
            messageCount.opcua++;
            document.getElementById('count-opcua').textContent = `${messageCount.opcua} æ¡æ¶ˆæ¯`;

            const container = document.getElementById('data-opcua');
            const timestamp = new Date().toLocaleTimeString('zh-CN', { hour12: false });

            container.innerHTML = `
                <div class="timestamp">â±ï¸ ${timestamp} | ä¸»é¢˜: ${topic}</div>
                <pre>${JSON.stringify(data, null, 2)}</pre>
            `;
        }
    </script>
</body>

</html>